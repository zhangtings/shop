@{
    Layout = null;
}
@model SHAN.Service.商家DTO
<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>商家编辑</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/Content/layui/css/layui.css" media="all" />
</head>
<body class="childrenBody">
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">基本信息</li>
            <li>轮播图</li>
            <li>商家介绍</li>
            <li>位置信息</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <form class="layui-form" style="width:80%;">
                    @Html.HiddenFor(r => r.Id)
                    @Html.HiddenFor(r => r.Lat)
                    @Html.HiddenFor(r => r.Lng)
                    @Html.HiddenFor(r => r.Zoom)
                    @Html.HiddenFor(r => r.Pic)
                    @Html.HiddenFor(r => r.ProductPic)
                    @Html.HiddenFor(r => r.Video)
                    @Html.HiddenFor(r => r.Des)
                    @Html.HiddenFor(r => r.ShenHe)
                    @Html.HiddenFor(r => r.Photox)
                    @Html.HiddenFor(r => r.Tags)
                    <div class="layui-form-item layui-row layui-col-xs12">
                        <label class="layui-form-label">商家名称</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input " name="Title" lay-verify="required" placeholder="" value="@Model.Title">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">设置折扣</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" id="Zhekou" name="Zhekou" type="text" value="@Model.Zhekou" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row layui-col-xs12">
                        <label class="layui-form-label">分类</label>
                        <div class="layui-input-block" id="分类菜单">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label ">地址</label>
                        <div class="layui-input-inline w600">
                            <input class="layui-input" id="Address" name="Address" type="text" value="@Model.Address" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label ">电话</label>
                        <div class="layui-input-inline w600">
                            <input class="layui-input" id="Tel" name="Tel" type="text" value="@Model.Tel" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label ">营业时间</label>
                        <div class="layui-input-inline w500">
                            <input class="layui-input" id="Quan" name="Quan" placeholder="如：早晨9:00-次日凌晨7:00" type="text" value="@Model.Quan" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label ">标签</label>
                        <div class="layui-input-inline w500">
                            <input class="layui-input" id="BiaoQian" name="BiaoQian" placeholder="逗号分隔" type="text" value="@Model.BiaoQian">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label ">广告语</label>
                        <div class="layui-input-inline w500">
                            <input class="layui-input" id="GuangGao" name="GuangGao" type="text" value="@Model.GuangGao">
                        </div>
                    </div>
                    <div class="layui-form-item layui-row layui-col-xs12">
                        <div class="layui-input-block">
                            <button class="layui-btn layui-btn-sm" lay-submit="" lay-filter="subbtn">提交</button>
                            <button type="reset" class="layui-btn layui-btn-sm layui-btn-primary">取消</button>
                        </div>
                    </div>

                </form>
            </div>
            <div class="layui-tab-item">
                <div class="layui-form-item">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="btnUpload-x">缩略图，大小230*230</button>
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;width:100px">
                            <div class="layui-upload-list" id="pics_x">
                                @{
                                    if (!string.IsNullOrEmpty(Model.Photox))
                                    {
                                        <img src="@Model.Photox" data-src="@Model.Photox" style="height:100px" />
                                    }
                                }
                            </div>
                        </blockquote>
                    </div>
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="btnUpload-d">视频(mp4)，最大20M</button>
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;width:200px">
                            <div class="layui-upload-list" id="pics_d">
                                @{
                                    if (!string.IsNullOrEmpty(Model.Video))
                                    {
                                        <video height="200" controls="controls" data-src="@Model.Video">
                                            <source src="@Model.Video" type="video/mp4" />
                                            浏览器不支持此视频播放
                                        </video>
                                    }
                                }
                            </div>
                        </blockquote>
                    </div>

                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="btnUpload3">轮播图，大小600*600，可多个</button>
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px; width:801px">
                            <div class="layui-upload-list" id="pics3">
                                @{
                                    if (!string.IsNullOrEmpty(Model.Pic))
                                    {
                                        foreach (var item in Model.Pic.Split(new string[] { "," }, StringSplitOptions.RemoveEmptyEntries))
                                        {
                                            <img src="@item" data-src="@item" height="200" />
                                        }
                                    }
                                }
                            </div>
                        </blockquote>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="layui-form-item layui-row layui-col-xs12">
                    <label class="layui-form-label">商家介绍</label>
                    <div class="layui-input-block">
                        <textarea id="富文本框" style="display: none;">@Model.Des</textarea>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item layui-show">
            </div>
        </div>

    </div>

    <script type="text/javascript" src="/Content/layui/layui.js"></script>
    <script type="text/html" id="选择分类">
        {{#  layui.each(d.list, function(index, item){ }}
        <input type="checkbox"  name="fenlei" value="{{item.Id}}" title="{{item.Name}}"  {{ item.ischeck==1 ? 'checked' : '' }}>
        {{#  }); }}
    </script>
    <script>
        layui.use(['form', 'laytpl', 'layer', "element", 'layedit', "upload"], function () {
            var form = layui.form
            layer = parent.layer === undefined ? layui.layer : top.layer,
                laytpl = layui.laytpl,
                $ = layui.jquery;
            var layedit = layui.layedit;
            var element = layui.element;
            //富文本框渲染
            layedit.set({
                uploadImage: {
                    url: '/ncpadmin/api/upload' 
                }
            });
            var 富文本 = layedit.build('富文本框', {
                height: 800 //设置编辑器高度
            });

            //分类菜单渲染
            $.get('/ncpadmin/Column/List?Name=商家分类', function (json) {
                var getTpl = 选择分类.innerHTML
                    , view = document.getElementById('分类菜单');
                var fenlei = { "list": json.data, "所属": $('#Tags').val() }
                var 所属 = $('#Tags').val().split(",").map(Number);
                layui.each(json.data, function (index, item) {
                    if (item.Name == "商家分类") {
                        json.data.splice(index,1);
                    }
                    else
                    {
                    if (所属.indexOf(item.Id)>-1) {
                        item.ischeck = 1;
                        }
                    }
                });
                laytpl(getTpl).render(fenlei, function (html) {
                    view.innerHTML = html;
                    element.init();
                    form.render('checkbox');
                });

            });

            //提交处理数据
            form.on("submit(subbtn)", function (data) {
                data.field.Cid = $('#cid').val();
                data.field.Des = layedit.getContent(富文本);
                var arr = new Array();
                $("input:checkbox[name='fenlei']:checked").each(function (i) {
                    arr[i] = $(this).val();
                });

                data.field.Tags = arr.toString();
                ////弹出loading
                //var index = layer.msg('数据提交中，请稍候', { icon: 16, time: false, shade: 0.8 });
                $.post("/ncpadmin/Business/Save", data.field, function (res) {
                    //layer.msg("保存成功！");
                    location.href = "Business";
                });
                return false;
            });
        });

    </script>
</body>
</html>
